# 抓取平台概要设计

|**时间**|**撰写人**|**修改内容**|**备注**|
|:-----:|:-------:|:---------:|:-----:|
|2018-09-12|王家葳|建立文档|初稿|
|2018-09-18|王家葳|修改|初稿|
|2018-09-19|王家葳|重新设计总设计图|初稿|

## 目录

- 背景
- 总体设计
- 总流程设计
- 消息框架设计
- 各模块功能
	- 调度节点
	- 代理节点
- 爬虫设计


## 背景

采集的数据越多，积累的抓取脚本就越多

由此产生额外的维护工作变多

需要一个抓取平台，负责调度，抓取，监控各任务状态

同时提升抓取效率

## 总体设计

![总设计架构图][2]

该抓取平台采取并列计算的架构模式

在消息框架内：

1. 调度，各节点通过消息队列来通信

1. 调度负责派发任务，监督各节点状态

1. 每一个Agent节点作为一个MsgCenter，肩负

	- 启动进程
	- 通信
	- 类似路由查询的作用


## 总流程设计

![总流程图][1]

调度在接受任务\定时任务时：

- 通过ssh去冷启动各个节点(node)
- 在启动节点后，该节点代理(Agent)开始监听任务队列
- 代理在接受到任务，启动一个子进程去执行该任务，同时记录好输入/输出队列


## 消息框架设计

![消息框架设计][3]

## 各模块功能

### 调度节点

1. 管理各个节点

	1.1 启动、关闭代理
		
	1.2 监听各节点汇报的节点状态去评估当前节点状态
	
	1.3 根据节点状态决定任务下达至指定节点
	
2. 任务的派发

	2.1 用户自定义任务
	
	2.2 定时调度任务

### 普通节点

1. 化身代理 Agent
	
	1.1 调度通过ssh连接至节点，随即启动代理
	
	1.2 监听指定任务队列，接收任务
	
	1.3 接收任务，创建脚本，开启进程去并执行脚本

2. MessageCenter
	
	2.1 该Agent作为当前节点的消息中心
	
	2.2 负责收发消息，维护路由表

3. 管理节点
	
	3.1 该Agent同时兼备管理功能
	
	3.2 定时向调度模块汇报当前节点 cpu/内存/硬盘/网络..状态
	
	3.3 通过监听各子进程消息/日志来判断当前任务状态
	
	3.4 **计算任务的完成度**

## 爬虫设计

![爬虫项目设计][4]

[1]: https://github.com/beforeuwait/spider_platform/blob/master/%E8%AE%BE%E8%AE%A1%E6%96%87%E6%A1%A3/%E6%8A%93%E5%8F%96%E5%B9%B3%E5%8F%B0%E6%B5%81%E7%A8%8B%E5%9B%BE.jpg?raw=true

[2]: https://github.com/beforeuwait/spider_platform/blob/master/%E8%AE%BE%E8%AE%A1%E6%96%87%E6%A1%A3/%E6%8A%93%E5%8F%96%E5%B9%B3%E5%8F%B0%E6%9E%B6%E6%9E%84%E5%9B%BE9-19.jpg?raw=true

[3]: https://github.com/beforeuwait/spider_platform/blob/master/%E8%AE%BE%E8%AE%A1%E6%96%87%E6%A1%A3/%E6%B6%88%E6%81%AF%E6%A1%86%E6%9E%B6.jpg?raw=true

[4]: https://github.com/beforeuwait/spider_platform/blob/master/%E8%AE%BE%E8%AE%A1%E6%96%87%E6%A1%A3/%E7%88%AC%E8%99%AB%E9%A1%B9%E7%9B%AE%E7%BB%93%E6%9E%84.jpg?raw=true